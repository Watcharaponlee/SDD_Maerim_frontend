<template>
    <div class="pa-3">
        <div>
            <v-card variant="flat" style="box-shadow: rgba(100, 100, 111, 0.2) 0px 5px 29px 0px;">
                <v-toolbar density="compact" color="white"
                    style="border-top-left-radius: 4px;border-top-right-radius: 4px;">
                    <h2 class="ml-5 d-flex align-center justify-start" style="color: #FE8329;">
                        <v-icon icon="mdi-calendar-check" size="small" class="mr-2" style="color: #FE8329;"></v-icon>
                        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏≠‡∏≠‡∏Å
                    </h2>
                    <v-spacer></v-spacer>
                    <p style="color: black;font-weight: 600;font-size: 25px;"
                        class="d-flex align-center justify-center pr-5">
                        <v-icon icon="mdi-clock" size="small" class="mr-2" color="primary"></v-icon>
                        {{ currentTime }}
                    </p>
                </v-toolbar>
                <v-row class="justify-space-between pa-3">
                    <v-col cols="4" v-for="stu in studentData" :key="stu._id">
                        <v-row class="pb-2">
                            <v-col>
                                <img :src="stu.img_name || '/profile_mockup.jpg'" alt="img" class="ImgBorder">
                            </v-col>
                            <v-col>
                                <img :src="stu.img_snap ? baseUrl + stu.img_snap : '/profile_mockup.jpg'" alt="Img"
                                    class="ImgBorder">
                            </v-col>
                        </v-row>
                        <v-card variant="flat" class="card-second-shadow">
                            <h3 class="text-center" style="background-color: #FE8329;color: white;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </h3>
                            <div class="pa-3">
                                <v-row class="align-center row-border">
                                    <v-col cols="3" class="text-center pa-0">
                                        <v-icon style="color: #005BB9; font-size: 35px;"
                                            icon="mdi-card-account-details" />
                                    </v-col>
                                    <v-col cols="9">
                                        <p class="FontDetail text-center">{{ stu.p_id || '-' }}</p>
                                    </v-col>
                                </v-row>
                                <v-row class="align-center row-border">
                                    <v-col cols="3" class="text-center pa-0">
                                        <v-icon style="color: #005BB9; font-size: 35px;" icon="mdi-account" />
                                    </v-col>
                                    <v-col cols="9">
                                        <p class="text-center FontDetail">{{ cutPrefixName(stu.name) || '-' }}</p>
                                    </v-col>
                                </v-row>
                                <v-row class="align-center">
                                    <v-col cols="3" class="text-center pa-0">
                                        <v-icon style="color: #43A047;font-size: 35px;" icon="mdi-clock-check" />
                                    </v-col>
                                    <v-col cols="9">
                                        <p class="text-center FontDetail">{{ extractTime(stu.time) || '-' }}</p>
                                    </v-col>
                                </v-row>
                            </div>
                        </v-card>
                    </v-col>
                </v-row>
            </v-card>
        </div>

        <div class="mt-2">
            <v-card variant="flat" style="box-shadow: rgba(100, 100, 111, 0.2) 0px 5px 29px 0px;">
                <v-toolbar density="compact" color="white"
                    style="border-top-left-radius: 4px;border-top-right-radius: 4px;">
                    <h3 class="ml-5 d-flex align-center justify-start" style="color: #FE8329;">
                        <v-icon icon="mdi-account" size="small" class="mr-2" style="color: #FE8329;"></v-icon>
                        ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </h3>
                    <v-spacer></v-spacer>
                </v-toolbar>
                <v-row class="text-center pa-3">
                    <v-col v-for="student in data" :key="student._id">
                        <img :src="student.img_name || '/profile_mockup.jpg'" alt="img" class="Imglist">
                        <p class="d-flex align-center justify-center FontSub">
                            <v-icon style="color: #005BB9; " icon="mdi-card-account-details" class="mr-3" />
                            {{ student.p_id }}
                        </p>
                        <p class="d-flex align-center justify-center FontSub">
                            <v-icon style="color: #43A047;" icon="mdi-clock-check" class="mr-3" />
                            {{ extractTime(student.time) }}
                        </p>
                    </v-col>
                </v-row>
            </v-card>
        </div>
    </div>
</template>

<script>
import { formatitemdevice, dateTimeFormatValue } from '../../function/day';
import moment from "moment-timezone"
export default {
    setup() {
        const baseUrl = import.meta.env.VITE_APP_BASE_URL;
        return {
            formatitemdevice,
            dateTimeFormatValue,
            baseUrl,
        };
    },
    data: () => ({
        studentData: [
            {
                Img: '/profile_mockup.jpg',
                p_id: "",
                name: "",
                time: ""
            },
            {
                Img: '/profile_mockup.jpg',
                p_id: "",
                name: "",
                time: ""
            },
            {
                Img: '/profile_mockup.jpg',
                p_id: "",
                name: "",
                time: ""
            },
        ],
        currentTime: moment().tz('Asia/Bangkok').format('DD/MM/YYYY HH:mm:ss'),
        deviceInfo: {
            serialNumber: '',
            location: '',
            name: '',
        },
        data: [
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
            {
                Img: '/profile_mockup.jpg',
                Id: "",
                name: "",
                timeST: ""
            },
        ],
        serverTime: '',
        headers: [
            { title: '‡∏•‡∏≥‡∏î‡∏±‡∏ö', align: 'center', sortable: false, key: 'index' },
            { title: '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', align: 'center', sortable: false, key: 'data.snapPicture' },
            { title: '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', align: 'center', sortable: false, key: 'data.name' },
            { title: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', align: 'center', sortable: false, key: 'data.position' },
            { title: '‡πÄ‡∏ß‡∏•‡∏≤', align: 'center', sortable: false, key: 'data.timestamp' },

        ],
        studentCounter: 0,
        FirstName: '',
        LastName: '',
        socket: null,
        socketReconnectTimeout: null, // <- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ clearTimeout
        isComponentAlive: true, // <- flag ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤ component ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
        lastClearedHour: null,
        clearInterval: null
    }),
    created() {
        setInterval(() => {
            this.currentTime = moment().tz('Asia/Bangkok').format('DD/MM/YYYY HH:mm:ss');
        }, 1000);
    },
    mounted() {
        this.deviceInfo.serialNumber = this.$route.query.serial;
        this.deviceInfo.location = this.$route.query.location;
        this.deviceInfo.name = this.$route.query.name;

        this.connectWebSocket();
        this.setupDataClearTimer();

        window.addEventListener('beforeunload', this.disconnectWebSocket);
    },
    beforeUnmount() {
        this.isComponentAlive = false;

        if (this.socket) {
            this.socket.close();
        }

        if (this.socketReconnectTimeout) {
            clearTimeout(this.socketReconnectTimeout);
            this.socketReconnectTimeout = null;
        }

        console.log("Component destroyed, WS disconnected.");

        if (this.clearInterval) {
            clearInterval(this.clearInterval);
            this.clearInterval = null;
        }
    },
    methods: {
        disconnectWebSocket() {
            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.close(1000, 'User navigated away');
                console.log('WebSocket disconnected on page leave.');
            }
        },
        getSocketUrl() {
            const isDevLocalhost = window.location.hostname === 'localhost' && window.location.port === '5173';

            if (isDevLocalhost) {
                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å .env ‡∏ï‡∏≠‡∏ô dev
                return import.meta.env.VITE_APP_SOCKET_URL;
            } else {
                // ‡πÉ‡∏ä‡πâ hostname ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ï‡πà path ‡πÅ‡∏•‡∏∞ port ‡πÄ‡∏î‡∏¥‡∏°
                const protocol = 'ws'; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ wss ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ https
                const hostname = window.location.hostname;
                return `${protocol}://${hostname}:3050/socket`;
            }
        },
        connectWebSocket() {
            const socketUrl = this.getSocketUrl();
            this.socket = new WebSocket(socketUrl);

            this.socket.onopen = () => {
                console.log('Connected !')
            };

            this.socket.onmessage = (event) => {
                const socketData = JSON.parse(event.data);

                if (socketData.sn === this.deviceInfo.serialNumber) {
                    if (socketData.p_id !== 'STRANGERBABY') {
                        if (this.studentData.length === 3) {
                            const removed = this.studentData.pop();
                            this.data.unshift(removed); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î

                            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ data ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10
                            if (this.data.length > 10) {
                                this.data.pop();
                            }
                        }

                        // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ studentData
                        this.studentData.unshift(socketData);

                        console.log('üìå studentData (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 3):', this.studentData);
                        console.log('üì¶ data (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10):', this.data);
                    } else {
                        console.log('Stranger : ', socketData)
                    }
                }
            };

            this.socket.onerror = (error) => {
                console.log('WebSocket Error', error)
            };

            this.socket.onclose = () => {
                console.log('Connection Closed!');
                // ‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô reconnect
                if (this.isComponentAlive) {
                    console.log('Attempting to reconnect in 3 seconds...');
                    this.socketReconnectTimeout = setTimeout(() => {
                        this.connectWebSocket();
                    }, 3000);
                }
            }
        },
        setupDataClearTimer() {
            this.clearInterval = setInterval(() => {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();

                console.log(`Checking time: ${hour}:${minute < 10 ? '0' + minute : minute}`);

                const isClearTime = (hour === 9 || hour === 19) && minute === 0;

                if (isClearTime && this.lastClearedHour !== hour) {
                    console.log(`üßπ Clearing data at ${hour}:00`);
                    this.data = [];
                    this.studentData.picture = null;
                    this.studentData.snapPicture = null;
                    this.lastClearedHour = hour;
                }

                if (minute > 0 && this.lastClearedHour === hour) {
                    this.lastClearedHour = null;
                }
            }, 60000); // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
        },
        // beforeDestroy() {
        //     if (this.socket) {
        //         this.socket.close();
        //     }
        // },
        extractTime(dateTimeString) {
            if (!dateTimeString) return null;

            const date = new Date(dateTimeString);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ date ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isNaN(date.getTime())) return null;

            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            return `${hour}:${minute}`;
        },
        cutPrefixName(name) {
            if (name) {
                return name.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß)/, '').trim();
            }
        },
        cutName(name) {
            if (name) {
                // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
                const newName = name.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß)/, '').trim();

                // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                const [firstName, ...lastName] = newName.split(' ');

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                this.FirstName = firstName || '';
                this.LastName = lastName.join(' ') || '';
            } else {
                this.FirstName = '';
                this.LastName = '';
            }
        },
        cutNameParts(name) {
            if (!name) return { first: '', last: '' };

            const trimmed = name.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß)/, '').trim();
            const [first, ...last] = trimmed.split(' ');

            return {
                first: first || '',
                last: last.join(' ') || ''
            };
        }
    },
}
</script>

<style scoped>
.ImgBorder {
    /* padding: 10px; */
    border-radius: 5px;
    width: 100%;
    height: 300px;
}

.Imglist {
    border-radius: 5px;
    width: 120px;
    height: 130px;
    margin-bottom: 5px;
}

.FontDetail {
    font-size: 22px;
    font-weight: 600;
}

.FontSub {
    font-size: 20px;
    font-weight: 500;
}

.FontHeader {
    font-size: 19px;
    font-weight: bold;
    text-align: center;
}

.overflow-y-auto {
    overflow-y: auto;
}

.card-second-shadow {
    box-shadow: rgba(149, 157, 165, 0.2) 0px 2px 24px;
}

.row-border {
    border-bottom: 1px solid #E0E0E0;
}
</style>